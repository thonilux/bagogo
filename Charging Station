#include <WiFi.h>
#include <HTTPClient.h>
#include <Wire.h>
#define cutoff 5
#define disinfektan 14
const int BUTTON = 4;
int i = 1;
int adc_value = 0;
int adc_value2 = 0;
int Power = 0;
int id = 1;

const char *ssid     = "PRN ICT";
const char *password = "prnict2021";

long previousMillis = 0;
long interval = 10000;

HTTPClient http;

void setup() {
  // put your setup code here, to run once:
  Serial.begin(115200);
  //WiFi Begin
  WiFi.begin(ssid, password);
  while ( WiFi.status() != WL_CONNECTED ) {
    delay ( 500 );
    Serial.print ( "." );
  }
  pinMode(cutoff,OUTPUT);
  pinMode(BUTTON,INPUT_PULLUP);
  pinMode(disinfektan,OUTPUT);
  digitalWrite(cutoff,HIGH);
Serial.println("Relay On");
//Baca Power (Tegangan x Arus)
    unsigned int x=0;
    float AcsValue=0.0,Samples=0.0,AvgAcs=0.0,AcsValueF=0.0;

     for (int x = 0; x < 150; x++){ //Get 150 samples
     AcsValue = analogRead(34);     //Read current sensor values   
     Samples = Samples + AcsValue;  //Add samples together
     delay (3); // let ADC settle before next sample 3ms

     // Read the Analog Input
      adc_value = analogRead(35); //Perlu dikonversinih!
      }
      AvgAcs=Samples/150.0;//Taking Average of Samples

     //((AvgAcs * (5.0 / 1024.0)) is converitng the read voltage in 0-5 volts
     //2.5 is offset(I assumed that arduino is working on 5v so the viout at no current comes
     //out to be 2.5 which is out offset. If your arduino is working on different voltage than 
     //you must change the offset according to the input voltage)
     //0.100v(100mV) is rise in output voltage when 1A current flows at input
     AcsValueF = (97.16 + ((2.5 - (AvgAcs * (5.0 / 1024.0)) )/0.100))/10;

     Power= adc_value*AcsValue;

     Serial.print("Current = ");
     Serial.println(AcsValueF);//Print the read current on Serial monitor
     Serial.print("Input Voltage = ");
     Serial.println(adc_value);
     Serial.print("Daya = ");
     Serial.println(Power);

     //Baca Tegangan Batt
     adc_value2 = analogRead(36); //ini juga perlu dikonversi
     Serial.print("Tegangan Battery =");
     Serial.println(adc_value2);

     //Kirim Web
     http.begin("https://enerma.id/gokart/api/ChargeData");
     http.addHeader("Content-Type", "application/x-www-form-urlencoded");
     String dataout = "id_gokart="+String(id)+"&solar=" + String(Power) +"&battery=" + String(adc_value2) +"&submit=enter";
     int httpResponseCode = http.POST(dataout);  
     Serial.println(httpResponseCode);
     http.end();
     i=1;   
     delay(1000);
}

void loop() {
  disinfektanData();
  sendData();
}
  
void disinfektanData(){
  //Get Data Website (Disinfektan)
  http.begin("https://enerma.id/gokart/api/getDisinfectant");
  int httpCode=http.GET();
  String response = http.getString();
  if(response=="1"){
    digitalWrite(disinfektan, HIGH);
    Serial.println("Disinfektan On");
  }
  if(response=="0"){
    digitalWrite(disinfektan,LOW);
    Serial.println("Disinfektan Off");
  }
  Serial.println(response);
  http.end();
  i++;

  //Button (Disinfektan)
  int buttonstate = digitalRead(BUTTON);
  if(buttonstate == LOW){
    digitalWrite(disinfektan,HIGH);
  }
  else if(buttonstate == HIGH){
    digitalWrite(disinfektan,LOW);
  }
}

void sendData(){
  unsigned long currentMillis = millis();
  digitalWrite(cutoff,LOW);
  Serial.println("Relay Off");
  delay(1000);
  if(currentMillis - previousMillis >= interval) {
    // save the last time you blinked the LED 
    previousMillis = currentMillis; 
    Serial.print("millis: ");
    Serial.println(currentMillis);
    digitalWrite(cutoff,HIGH);
    Serial.println("Relay On");
    //Baca Power (Tegangan x Arus)
    unsigned int x=0;
    float AcsValue=0.0,Samples=0.0,AvgAcs=0.0,AcsValueF=0.0;

     for (int x = 0; x < 150; x++){ //Get 150 samples
     AcsValue = analogRead(34);     //Read current sensor values   
     Samples = Samples + AcsValue;  //Add samples together
     delay (3); // let ADC settle before next sample 3ms

     // Read the Analog Input
      adc_value = analogRead(35);
      }
      AvgAcs=Samples/150.0;//Taking Average of Samples

     //((AvgAcs * (5.0 / 1024.0)) is converitng the read voltage in 0-5 volts
     //2.5 is offset(I assumed that arduino is working on 5v so the viout at no current comes
     //out to be 2.5 which is out offset. If your arduino is working on different voltage than 
     //you must change the offset according to the input voltage)
     //0.100v(100mV) is rise in output voltage when 1A current flows at input
     AcsValueF = (97.16 + ((2.5 - (AvgAcs * (5.0 / 1024.0)) )/0.100))/10;

     Power= adc_value*AcsValue;

     Serial.print("Current = ");
     Serial.println(AcsValueF);//Print the read current on Serial monitor
     Serial.print("Input Voltage = ");
     Serial.println(adc_value);
     Serial.print("Daya = ");
     Serial.println(Power);

     //Baca Tegangan Batt
     adc_value2 = analogRead(36);
     Serial.print("Tegangan Battery =");
     Serial.println(adc_value2);
     http.begin("https://enerma.id/gokart/api/ChargeData");
     http.addHeader("Content-Type", "application/x-www-form-urlencoded");
     String dataout = "id_gokart="+String(id)+"&solar=" + String(Power) +"&battery=" + String(adc_value2) +"&submit=enter";
     int httpResponseCode = http.POST(dataout);  
     Serial.println(httpResponseCode);
     http.end();
     i=1;   
     delay(1000);
  }
}
    
